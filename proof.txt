#!/bin/bash

directory_check=$(ls -A $(pwd) | wc -l)
commandslist=('sudo apt update' 'sudo apt upgrade -y' 'sudo apt autoremove')
mirrors=('git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' 'git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git')
cmd_connectivity="ping google.com -c1 &> /dev/null"
cmd_single_instance="pidof -x $(basename $0) &> /dev/null"

update_ubuntu(){
	for i in "${commandslist[@]}"; do
		eval $i
		status=$?
		echo "The ubuntu update command ended with status $status at $(date)" >> log.txt
	done
}

update_mirrors(){
	for i in "${mirrors[@]}"; do
		if [ $directory_check -gt 0 ]; then
			echo "$dir is not empty"
			git init
			git pull $i
			status=$?
			echo "The mirror update command ended with status $status at $(date)" >> log.txt

		else
			echo "$dir is empty"
			git init
			git clone $i
			git pull $i
			status=$?
		echo "The mirror clone and update commands ended with status $status at $(date)" >> log.txt
		fi
	done
}

check_connectivity(){
	for i in {1..5}; do
		eval $cmd_connectivity
		status=$?
		echo "Network check command ended with status $status at $(date)" >> log.txt

	if [ $status -eq 0 ]
	then
		echo "Connectivity OK"
		return 0
	fi

	echo "Connectivity NOK($cmd_connectivity), trying to recconect($i)..."
	sleep 20
done

echo "Connectivity NOK, exiting!"
exit 1
}

check_single_instance(){
	for pid in $($cmd_single_instance); do
	if [ $pid != $$ ]; then
		echo "[$(date)] : $(basename $0): Process is already running with PID $pid"
		exit 1
	fi
	done
}
check_statuses(){
	cat log.txt | tail -6
}

check_connectivity
check_single_instance
update_ubuntu
update_mirrors
check_statuses

corin@otp-cdobrica-l1:~/Desktop/Task2test$ ./myupdater.sh 
Connectivity OK
Hit:1 http://mirrors.nav.ro/ubuntu jammy InRelease
Hit:2 http://mirrors.nav.ro/ubuntu jammy-updates InRelease
Hit:3 http://mirrors.nav.ro/ubuntu jammy-backports InRelease
Hit:4 http://mirrors.nav.ro/ubuntu jammy-security InRelease
Hit:5 http://packages.microsoft.com/repos/code stable InRelease
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
All packages are up to date.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Calculating upgrade... Done
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
 is not empty
Reinitialized existing Git repository in /home/corin/Desktop/Task2test/.git/
From git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux
 * branch                      HEAD       -> FETCH_HEAD
Already up to date.
 is not empty
Reinitialized existing Git repository in /home/corin/Desktop/Task2test/.git/
From git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux
 * branch                      HEAD       -> FETCH_HEAD
Already up to date.
Network check command ended with status 0 at luni 18 iulie 2022, 17:07:25 +0300
The ubuntu update command ended with status 0 at luni 18 iulie 2022, 17:07:27 +0300
The ubuntu update command ended with status 0 at luni 18 iulie 2022, 17:07:27 +0300
The ubuntu update command ended with status 0 at luni 18 iulie 2022, 17:07:28 +0300
The mirror update command ended with status 0 at luni 18 iulie 2022, 17:07:29 +0300
The mirror update command ended with status 0 at luni 18 iulie 2022, 17:07:29 +0300


crontab schedule:
00 01 * * * /home/corin/Desktop/Task2/myupdater.sh

